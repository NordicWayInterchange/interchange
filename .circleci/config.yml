version: 2.1
orbs:
  gcloud: ceddy/gcloud@0.0.2
executors:
  my-machine:
    machine: true
    working_directory: ~/interchange
  helm3:
    working_directory: ~/helm
    docker:
      - image: banzaicloud/helm:0.0.7

jobs:
  build:
    executor: my-machine
    steps:
      - checkout
      - run:
          name: run integration tests
          command: |
            mvn verify -Dorg.slf4j.simpleLogger.log.org.apache.maven=warn -B
      - persist_to_workspace:
          root: ~/interchange
          paths:
            - ./*
  maven-deploy:
    executor: my-machine
    steps:
      - attach_workspace:
          at: ~/interchange
      - run:
          branch: federation-master
          name: Push maven build
          command: |
            mvn -DskipTests=true -s .circleci.settings.xml deploy -Dorg.slf4j.simpleLogger.log.org.apache.maven=warn -B
  docker-build-push-bouvet:
    executor: my-machine
    steps:
      - attach_workspace:
          at: ~/interchange
      - run:
          name: Build and push containers to Bouvet
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
            gcloud docker --authorize-only
            chmod +x build-push-images.sh
            ./build-push-images.sh eu.gcr.io/nordic-way-aad182cc
  docker-build-push-svv:
      executor: my-machine
      steps:
      - attach_workspace:
          at: ~/interchange
      - run:
          name: Build and push containers to SVV
          command: |
            echo $SVV_GCLOUD_CIRCLE_CI_BASE64 | base64 -d - | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${SVV_GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${SVV_GOOGLE_COMPUTE_ZONE}
            gcloud docker --authorize-only
            chmod +x build-push-images.sh
            ./build-push-images.sh eu.gcr.io/nw-interchange-stm-whya
  helm-package-charts:
      executor: helm3
      steps:
        - checkout
        - run:
            name: Package helm charts
            command: |
              helm package ~/helm/helm/interchange
              helm repo index ~/helm/helm
        - persist_to_workspace:
            root: ~/helm
            paths:
              - ./helm/*

  helm-publish-charts:
      executor: helm3
      steps:
        - attach_workspace:
            at: ~/helm
        - run:
            name: Authenticate google cloud
            command: |
              echo $SVV_GCLOUD_CIRCLE_CI_BASE64 | base64 -d - | gcloud auth activate-service-account --key-file=-
              gcloud --quiet config set project ${SVV_GOOGLE_PROJECT_ID}
              gcloud --quiet config set compute/zone ${SVV_GOOGLE_COMPUTE_ZONE}

workflows:
  version: 2.1
  build_and_docker_push:
    jobs:
      - build
      - docker-build-push-svv:
          requires:
          - build
      - docker-build-push-bouvet:
          requires:
            - docker-build-push-svv
      - maven-deploy:
          filters:
            branches:
              only:
                - federation-master
          requires:
            - docker-build-push-bouvet
  helm-repo:
    jobs:
      - helm-package-charts
      - helm-publish-charts:
          requires:
            - helm-package-charts

