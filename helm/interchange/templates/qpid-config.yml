kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ .Release.Name }}-qpid
  labels:
    app: {{ .Chart.Name }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    component: qpid
    release: {{ .Release.Name }}
data:
  passwd: |
    {{ .Values.qpid.admin_user }}:{{ .Values.qpid.admin_password }}
    {{ .Values.qpid.interchange_user }}:{{ .Values.qpid.interchange_password }}
  groups: |
    messaging-users.users={{ range .Values.qpid.users }}{{ .name }},{{ end }}
    administrators.users={{ .Values.qpid.admin_user }}
  default.json: |
    {
      "type": "BDB",
      "name": "{{ .Values.external_name }}",
      "modelVersion": "7.0",
      "exchanges": [
        {
          "name": "nwEx",
          "type": "headers",
          "durable": true,
          "durableBindings": [
            {
              "arguments": {
                "x-filter-jms-selector": "where1='NO'"
              },
              "bindingKey": "where1",
              "destination": "NO-out"
            },
            {{- range .Values.qpid.users }}
            {
              "arguments": {
                "x-filter-jms-selector": "where1='{{ .binding }}'"
              },
              "bindingKey": "where1",
              "destination": "{{ .name }}"
            },
            {{- end }}
            {
              "arguments": {
                "x-filter-jms-selector": "where1 LIKE '%'"
              },
              "bindingKey": "where1",
              "destination": "test-out"
            }
          ]
        }
      ],
      "queues": [
        {
          "name": "test-out",
          "type": "standard",
          "durable": true,
          "holdOnPublishEnabled": false,
          "owner": null
        },
        {
          "name": "dlqueue",
          "type": "standard",
          "durable": true,
          "holdOnPublishEnabled": false,
          "owner": null
        },
        {{- range .Values.qpid.users }}
        {
          "name": "{{ .name }}",
          "type": "standard",
          "durable": true,
          "holdOnPublishEnabled": false,
          "owner": null
        },
        {{- end }}
        {
          "name": "onramp",
          "type": "standard",
          "durable": true,
          "holdOnPublishEnabled": false,
          "owner": null
        }
      ],
      "virtualhostaccesscontrolproviders": [
        {
          "name": "default",
          "type": "RuleBased",
          "defaultResult": "DENIED",
          "rules": [
            {
              "objectType": "ALL",
              "identity": "{{ .Values.qpid.interchange_user }}",
              "operation": "ALL",
              "outcome": "ALLOW_LOG",
              "attributes": {}
            },
            {
              "objectType": "EXCHANGE",
              "identity": "messaging-users",
              "operation": "PUBLISH",
              "outcome": "ALLOW_LOG",
              "attributes": {
                "ROUTING_KEY": "onramp",
                "NAME": ""
              }
            },
            {
              "objectType": "VIRTUALHOST",
              "identity": "messaging-users",
              "operation": "ACCESS",
              "outcome": "ALLOW_LOG",
              "attributes": {
                "NAME": "{{ .Values.external_name }}"
              }
            },
            {
              "objectType": "QUEUE",
              "identity": "messaging-users",
              "operation": "CONSUME",
              "outcome": "ALLOW_LOG",
              "attributes": {
                "NAME": "test-out"
              }
            },
            {{- range .Values.qpid.users }}
            {
              "objectType": "QUEUE",
              "identity": "{{ .name }}",
              "operation": "CONSUME",
              "outcome": "ALLOW_LOG",
              "attributes": {
                "NAME": "{{ .name }}"
              }
            },
            {{- end }}
            {
              "objectType": "ALL",
              "identity": "ALL",
              "operation": "ALL",
              "outcome": "DENY_LOG",
              "attributes": {}
            }
          ]
        }
      ]
    }
